{% extends "layout.html" %}

{% block title %}Dashboard - Activity Tracker{% endblock %}

<!-- Hidden input for URL passing to JavaScript -->
<input type="hidden" id="add-activity-url" value="{{ url_for('activities.add_activity') }}">

{% macro stat_card(label, value, subtitle, icon, color='primary') %}
<div class="bg-dark-secondary border border-dark rounded-lg p-4 hover:border-gray-700 transition-colors">
    <div class="flex items-center justify-between mb-2">
        <span class="text-xs font-medium text-secondary uppercase tracking-wide">{{ label }}</span>
        <i class="fas fa-{{ icon }} text-{{ color }} text-sm opacity-50"></i>
    </div>
    <p class="text-2xl font-semibold text-white mb-0.5">{{ value }}</p>
    <p class="text-xs text-secondary">{{ subtitle }}</p>
</div>
{% endmacro %}

{% macro status_badge(status) %}
{% set status_config = {
    'Ongoing': {'bg': 'bg-yellow-900/20', 'text': 'text-yellow-400', 'border': 'border-yellow-600/30', 'icon': ''},
    'Closed': {'bg': 'bg-green-900/20', 'text': 'text-green-400', 'border': 'border-green-600/30', 'icon': ''},
    'NA': {'bg': 'bg-gray-700/20', 'text': 'text-gray-400', 'border': 'border-gray-600/30', 'icon': ''}
} %}
{% set config = status_config.get(status, status_config['NA']) %}
<span class="inline-flex items-center px-2 py-0.5 text-xs font-medium {{ config.bg }} {{ config.text }} rounded border {{ config.border }}">
    {{ status }}
</span>
{% endmacro %}

{% block content %}
<div class="mb-6">
    <h2 class="text-2xl font-semibold text-white mb-1">Dashboard</h2>
    <p class="text-secondary text-sm">Your ongoing activities</p>
</div>

<!-- Quick Stats -->
<div class="grid grid-cols-2 md:grid-cols-3 gap-4 mb-6">
    {{ stat_card('Active', dashboard_stats.active_count, dashboard_stats.high_priority_count ~ ' high priority', 'tasks') }}
    {{ stat_card('Blockers', dashboard_stats.blocker_count, 'Need attention', 'exclamation-triangle', 'red-400') }}
    {{ stat_card('Updates', dashboard_stats.updates_this_week, 'this week', 'calendar-check', 'green-400') }}
</div>

<!-- Focus Mode Toggle (Hidden by default) -->
<div class="hidden mb-6 flex items-center justify-between">
    <button onclick="toggleFocusMode()" id="focusModeBtn" class="text-secondary hover:text-white text-sm flex items-center gap-2">
        <i class="fas fa-crosshairs"></i>
        <span id="focusModeText">Focus Mode</span>
    </button>
    <span id="focusModeHint" class="hidden text-xs text-secondary italic">Top 3 high-priority</span>
</div>

<!-- Search and Filters -->
<div class="bg-dark-secondary border border-dark rounded-lg p-4 mb-6">
    <div class="flex items-center justify-between mb-3">
        <h3 class="text-sm font-medium text-white">Filters</h3>
        <button onclick="document.getElementById('filterContent').classList.toggle('hidden')" class="text-secondary hover:text-white text-xs">
            <i class="fas fa-chevron-down"></i>
        </button>
    </div>
    <div id="filterContent" class="hidden">
        <form method="GET" action="{{ url_for('activities.dashboard') }}" class="flex flex-wrap gap-3 items-end">
        <div class="flex-1 min-w-[200px]">
            <label for="search" class="block text-xs font-medium text-secondary mb-1.5">Search</label>
            <input type="text" id="search" name="search" value="{{ request.args.get('search', '') }}" 
                   placeholder="Search activities..."
                   class="w-full px-3 py-2 bg-dark border border-dark rounded-lg text-white text-sm focus:outline-none focus:border-gray-600">
        </div>
        <div>
            <label for="filter_priority" class="block text-xs font-medium text-secondary mb-1.5">Priority</label>
            <select id="filter_priority" name="priority" class="px-3 py-2 bg-dark border border-dark rounded-lg text-white text-sm focus:outline-none focus:border-gray-600">
                <option value="">All</option>
                <option value="High" {% if request.args.get('priority')=='High' %}selected{% endif %}>High</option>
                <option value="Medium" {% if request.args.get('priority')=='Medium' %}selected{% endif %}>Medium</option>
                <option value="Low" {% if request.args.get('priority')=='Low' %}selected{% endif %}>Low</option>
            </select>
        </div>
        <div>
            <label for="filter_status" class="block text-xs font-medium text-secondary mb-1.5">Status</label>
            <select id="filter_status" name="status" class="px-3 py-2 bg-dark border border-dark rounded-lg text-white text-sm focus:outline-none focus:border-gray-600">
                <option value="">All</option>
                <option value="Ongoing" {% if request.args.get('status')=='Ongoing' %}selected{% endif %}>Ongoing</option>
                <option value="NA" {% if request.args.get('status')=='NA' %}selected{% endif %}>N/A</option>
            </select>
        </div>
        <div class="flex items-center pt-3">
            <label class="flex items-center text-xs text-secondary cursor-pointer hover:text-white">
                <input type="checkbox" id="has_blockers" name="has_blockers" value="1" {% if request.args.get('has_blockers') %}checked{% endif %}
                       class="mr-2 bg-dark border-dark rounded">
                Has Blockers
            </label>
        </div>
        <div class="flex gap-2 pt-3">
            <button type="submit" class="bg-white text-black px-4 py-2 rounded-lg text-sm font-medium hover:bg-gray-200 transition">
                Apply
            </button>
            <a href="{{ url_for('activities.dashboard') }}" class="bg-dark-secondary border border-dark text-white px-4 py-2 rounded-lg text-sm hover:bg-dark-hover transition">
                Clear
            </a>
        </div>
    </form>
    </div>
</div>

<!-- Quick Actions Panel - Hidden by default -->
<div class="hidden bg-dark-secondary border border-dark rounded-lg p-4 mb-6" id="quickActionsPanel">
    <h3 class="text-sm font-medium text-white mb-3 flex items-center">
        <i class="fas fa-bolt text-white mr-2 text-sm opacity-60"></i>
        Quick Actions
    </h3>
    <div class="flex flex-wrap gap-2">
        <!-- Quick Add Templates -->
        <button onclick="quickAddTemplate('Meeting Follow-up')" class="text-secondary hover:text-white px-3 py-1.5 text-xs border border-dark rounded hover:bg-dark-hover transition">
            Meeting Follow-up
        </button>
        <button onclick="quickAddTemplate('Awaiting Response')" class="text-secondary hover:text-white px-3 py-1.5 text-xs border border-dark rounded hover:bg-dark-hover transition">
            Awaiting Response
        </button>
        <button onclick="quickAddTemplate('Research Task')" class="text-secondary hover:text-white px-3 py-1.5 text-xs border border-dark rounded hover:bg-dark-hover transition">
            Research Task
        </button>
        <button onclick="quickAddTemplate('Review Needed')" class="text-secondary hover:text-white px-3 py-1.5 text-xs border border-dark rounded hover:bg-dark-hover transition">
            Review Needed
        </button>
        
        <!-- Bulk Actions -->
        <button onclick="toggleBulkMode()" id="bulkModeBtn" class="bg-white text-black px-3 py-1.5 text-xs rounded hover:bg-gray-200 transition">
            Bulk Select
        </button>
        <button onclick="bulkCloseSelected()" id="bulkCloseBtn" class="hidden bg-green-600 hover:bg-green-700 text-white px-3 py-1.5 text-xs rounded transition">
            Close Selected
        </button>
        <button onclick="bulkSetPriority()" id="bulkPriorityBtn" class="hidden bg-yellow-600 hover:bg-yellow-700 text-white px-3 py-1.5 text-xs rounded transition">
            Set Priority
        </button>
        <button onclick="cancelBulkMode()" id="cancelBulkBtn" class="hidden text-secondary hover:text-white px-3 py-1.5 text-xs border border-dark rounded hover:bg-dark-hover transition">
            Cancel
        </button>
    </div>
</div>

<!-- Smart Suggestions - Hidden by default -->
{% if smart_suggestions.stale_activities or smart_suggestions.long_running %}
<div class="hidden bg-dark-secondary border border-yellow-600/30 rounded-lg p-4 mb-6 border-l-2" id="smartSuggestions">
    <h3 class="text-sm font-medium text-white mb-3 flex items-center">
        <i class="fas fa-lightbulb text-yellow-400 mr-2 text-sm opacity-60"></i>
        Suggestions
    </h3>
    
    {% if smart_suggestions.stale_activities %}
    <div class="mb-3">
        <p class="text-xs font-medium text-yellow-400 mb-2">Stale (14+ days)</p>
        <div class="space-y-1.5">
            {% for activity in smart_suggestions.stale_activities[:3] %}
            <div class="flex items-center justify-between p-2 bg-dark rounded hover:bg-dark-hover transition">
                <a href="{{ url_for('activities.edit_activity', id=activity.id) }}" class="text-white hover:text-gray-300 flex-1 text-sm">
                    {{ activity.activity_desc[:50] }}{% if activity.activity_desc|length > 50 %}...{% endif %}
                </a>
                <span class="text-secondary text-xs ml-2">{{ activity.days_since }}d</span>
            </div>
            {% endfor %}
        </div>
    </div>
    {% endif %}
    
    {% if smart_suggestions.long_running %}
    <div>
        <p class="text-xs font-medium text-orange-400 mb-2">Long-Running (30+ days)</p>
        <div class="space-y-1.5">
            {% for activity in smart_suggestions.long_running[:3] %}
            <div class="flex items-center justify-between p-2 bg-dark rounded hover:bg-dark-hover transition">
                <a href="{{ url_for('activities.edit_activity', id=activity.id) }}" class="text-white hover:text-gray-300 flex-1 text-sm">
                    {{ activity.activity_desc[:50] }}{% if activity.activity_desc|length > 50 %}...{% endif %}
                </a>
                <span class="text-secondary text-xs ml-2">{{ activity.days_running }}d</span>
            </div>
            {% endfor %}
        </div>
    </div>
    {% endif %}
</div>
{% endif %}

<!-- Weekly Goals Section -->
<div class="bg-dark-secondary border border-dark rounded-lg p-4 mb-6">
    <div class="flex items-center justify-between mb-3">
        <h3 class="text-sm font-medium text-white flex items-center">
            <i class="fas fa-bullseye text-white mr-2 text-sm opacity-60"></i>
            Weekly Goals
        </h3>
        <button onclick="toggleGoalForm()" class="text-secondary hover:text-white text-xs">
            <i class="fas fa-plus mr-1"></i> Add
        </button>
    </div>
    
    <!-- Add Goal Form (Hidden by default) -->
    <div id="goalForm" class="hidden mb-3">
        <form action="{{ url_for('goals.add_goal') }}" method="POST" class="flex gap-2">
            <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">
            <input type="text" name="text" placeholder="New goal..." required 
                   class="flex-1 px-3 py-2 bg-dark border border-dark rounded-lg text-white text-sm focus:outline-none focus:border-gray-600">
            <button type="submit" class="bg-white text-black px-4 py-2 rounded-lg text-sm font-medium hover:bg-gray-200 transition">
                Save
            </button>
            <button type="button" onclick="toggleGoalForm()" class="text-secondary hover:text-white px-3 py-2 text-sm">
                Cancel
            </button>
        </form>
    </div>
    
    <!-- Goals List -->
    <div class="space-y-1.5">
        {% if goals %}
            {% for goal in goals %}
            <div class="flex items-center p-2 bg-dark rounded hover:bg-dark-hover transition">
                <a href="{{ url_for('goals.toggle_goal', id=goal.id) }}" class="mr-2">
                    {% if goal.is_complete %}
                        <i class="fas fa-check-circle text-green-400 text-sm"></i>
                    {% else %}
                        <i class="far fa-circle text-secondary text-sm"></i>
                    {% endif %}
                </a>
                <span class="flex-1 text-sm {% if goal.is_complete %}line-through text-secondary{% else %}text-white{% endif %}">
                    {{ goal.text }}
                </span>
            </div>
            {% endfor %}
        {% else %}
            <p class="text-secondary text-center py-4">No goals set for this week. Add one to get started!</p>
        {% endif %}
    </div>
</div>

<!-- Activities by Priority -->
{% set priorities = ['High', 'Medium', 'Low'] %}
{% set priority_colors = {'High': 'red', 'Medium': 'yellow', 'Low': 'white'} %}
{% set priority_bg = {'High': 'bg-red-900/20', 'Medium': 'bg-yellow-900/20', 'Low': 'bg-gray-800'} %}
{% set priority_text = {'High': 'text-red-400', 'Medium': 'text-yellow-400', 'Low': 'text-white'} %}
{% set priority_icons = {'High': 'fa-exclamation-circle', 'Medium': 'fa-minus-circle', 'Low': 'fa-info-circle'} %}

{% for priority in priorities %}
    {% set priority_activities = activities | selectattr('priority', 'equalto', priority) | list %}
    {% if priority_activities %}
    <div class="bg-dark-secondary border border-dark rounded-lg overflow-hidden mb-6 priority-section" data-priority="{{ priority }}">
        <div class="p-3 {{ priority_bg[priority] }} border-b border-dark cursor-pointer hover:opacity-90 transition" onclick="togglePrioritySection('{{ priority }}')">
            <h3 class="text-sm font-medium flex items-center">
                <span class="w-2 h-2 rounded-full {{ priority == 'High' and 'bg-red-500' or (priority == 'Medium' and 'bg-yellow-500' or 'bg-green-500') }} mr-2"></span>
                <span class="{{ priority_text[priority] }}">{{ priority }}</span>
                <span class="ml-2 text-secondary text-xs">
                    {{ priority_activities | length }}
                </span>
                <i class="fas fa-chevron-down ml-auto text-xs transition-transform" id="chevron-{{ priority }}"></i>
            </h3>
        </div>
        
        <div class="priority-content" id="content-{{ priority }}"{% if priority != 'High' %} style="display:none;"{% endif %}>
        <div class="overflow-x-auto">
            <table class="w-full activity-table">
                <thead class="bg-dark border-b border-dark">
                    <tr>
                        <th class="px-4 py-2 text-left text-xs font-medium text-secondary">Activity</th>
                        <th class="px-4 py-2 text-left text-xs font-medium text-secondary col-source">Source</th>
                        <th class="px-4 py-2 text-left text-xs font-medium text-secondary cursor-pointer hover:text-white col-start_date" onclick="toggleSort('start_date')">
                            Start
                            {% if request.args.get('sort') == 'start_date' %}
                                <i class="fas fa-sort-{% if request.args.get('dir')=='desc' %}down{% else %}up{% endif %} ml-1"></i>
                            {% endif %}
                        </th>
                        <th class="px-4 py-2 text-left text-xs font-medium text-secondary cursor-pointer hover:text-white" onclick="toggleSort('status')">
                            Status
                            {% if request.args.get('sort') == 'status' %}
                                <i class="fas fa-sort-{% if request.args.get('dir')=='desc' %}down{% else %}up{% endif %} ml-1"></i>
                            {% endif %}
                        </th>
                        <th class="px-4 py-2 text-left text-xs font-medium text-secondary w-1/4">Updates</th>
                        <th class="px-4 py-2 text-center text-xs font-medium text-secondary w-16"></th>
                    </tr>
                </thead>
                <tbody class="divide-y divide-dark/50">
                    {% for activity in priority_activities %}
                    <tr class="hover:bg-dark-hover/50 transition group cursor-pointer" 
                        data-activity-id="{{ activity.id }}"
                        data-activity-desc="{{ activity.activity_desc[:60]|e }}"
                        data-activity-bp="{{ (activity.blocking_points or '')|e }}"
                        data-activity-status="{{ activity.status|e }}"
                        onclick="window.location='{{ url_for('activities.activity_detail', id=activity.id) }}'">
                        <td class="px-4 py-3">
                            <div class="flex items-start gap-2">
                                <input type="checkbox" id="bulk-{{ activity.id }}" name="bulk_select" class="bulk-checkbox hidden mt-1" data-activity-id="{{ activity.id }}" onclick="event.stopPropagation()">
                                <div class="flex-1 min-w-0">
                                    <div class="text-sm text-white truncate">{{ activity.activity_desc[:80] }}{% if activity.activity_desc|length > 80 %}...{% endif %}</div>
                                    {% if activity.blocking_points %}
                                    <div class="text-xs text-red-400 mt-0.5 truncate">
                                        <i class="fas fa-exclamation-triangle mr-1"></i>{{ activity.blocking_points[:50] }}{% if activity.blocking_points|length > 50 %}...{% endif %}
                                    </div>
                                    {% endif %}
                                </div>
                            </div>
                        </td>
                        <td class="px-4 py-3 col-source">
                            <span class="text-xs text-secondary">{{ activity.source or 'N/A' }}</span>
                        </td>
                        <td class="px-4 py-3 text-xs text-secondary col-start_date">
                            {{ activity.start_date.strftime('%m/%d') }}
                        </td>
                        <td class="px-4 py-3">
                            <div id="st_display_{{ activity.id }}" class="flex items-center gap-1">
                                {{ status_badge(activity.status) }}
                                <button class="opacity-0 group-hover:opacity-100 text-secondary hover:text-white text-xs transition" title="Edit status" data-id="{{ activity.id }}" data-current="{{ activity.status|e }}" onclick="event.stopPropagation(); editStatus({{ activity.id }}, '{{ activity.status|e }}')">
                                    <i class="fas fa-pen text-[10px]"></i>
                                </button>
                            </div>
                            <div id="st_edit_{{ activity.id }}" class="hidden">
                                <div class="flex items-center gap-1">
                                    <select id="st_select_{{ activity.id }}" class="px-2 py-1 bg-dark border border-dark rounded text-white text-xs focus:outline-none focus:border-gray-600">
                                        <option value="Ongoing" {% if activity.status=='Ongoing' %}selected{% endif %}>Ongoing</option>
                                        <option value="Closed" {% if activity.status=='Closed' %}selected{% endif %}>Closed</option>
                                        <option value="NA" {% if activity.status=='NA' %}selected{% endif %}>N/A</option>
                                    </select>
                                    <button type="button" class="bg-white text-black px-2 py-1 text-xs rounded hover:bg-gray-200 transition save-status-btn" data-id="{{ activity.id }}">✓</button>
                                    <button type="button" class="text-secondary hover:text-white px-2 py-1 text-xs cancel-status-btn" data-id="{{ activity.id }}">×</button>
                                </div>
                            </div>
                        </td>
                        <td class="px-4 py-3">
                            <div class="space-y-1 max-h-24 overflow-y-auto">
                                {% if activity_updates.get(activity.id) %}
                                    {% for u in activity_updates[activity.id][:2] %}
                                    <div class="text-xs p-1.5 bg-dark rounded">
                                        <div class="text-secondary text-[10px] mb-0.5">{{ u.created_at|timeago }}</div>
                                        <div class="text-white">{{ u.text[:60] }}{% if u.text|length > 60 %}...{% endif %}</div>
                                    </div>
                                    {% endfor %}
                                    {% if activity_updates[activity.id]|length > 2 %}
                                    <div class="text-[10px] text-secondary">+{{ activity_updates[activity.id]|length - 2 }} more</div>
                                    {% endif %}
                                {% else %}
                                    <div class="text-xs text-secondary italic">No updates</div>
                                {% endif %}
                            </div>
                            <div class="mt-1.5">
                                <input type="text"
                                       id="inline-update-{{ activity.id }}"
                                       name="inline_update"
                                       class="inline-update-input w-full px-2 py-1 text-xs rounded focus:outline-none"
                                       style="background: var(--md-sys-color-surface-container); border: 1px solid var(--md-sys-color-outline-variant); color: var(--md-sys-color-on-surface);"
                                       placeholder="Quick update..."
                                       data-activity-id="{{ activity.id }}"
                                       onclick="event.stopPropagation()">
                            </div>
                        </td>
                        <td class="px-4 py-3 text-center">
                            <div class="relative inline-block" onclick="event.stopPropagation()">
                                <button class="text-secondary hover:text-white transition text-sm" onclick="toggleActionMenu({{ activity.id }})">
                                    <i class="fas fa-ellipsis-v"></i>
                                </button>
                                <div id="actionMenu{{ activity.id }}" class="hidden absolute right-0 mt-1 w-32 bg-dark-secondary border border-dark rounded-lg shadow-xl z-10">
                                    <a href="{{ url_for('activities.edit_activity', id=activity.id) }}" 
                                       class="block px-3 py-2 text-xs text-white hover:bg-dark-hover">
                                        <i class="fas fa-edit mr-2"></i>Edit
                                    </a>
                                    <button type="button"
                                            class="quick-update-btn block w-full text-left px-3 py-2 text-xs text-white hover:bg-dark-hover"
                                            data-id="{{ activity.id }}"
                                            data-desc="{{ activity.activity_desc[:60]|e }}"
                                            data-bp="{{ (activity.blocking_points or '')|e }}">
                                        <i class="fas fa-comment-medical mr-2"></i>Update
                                    </button>
                                    <a href="{{ url_for('activities.add_activity') }}?clone={{ activity.id }}" 
                                       class="block px-3 py-2 text-xs text-white hover:bg-dark-hover">
                                        <i class="fas fa-clone mr-2"></i>Clone
                                    </a>
                                    <button type="button"
                                            class="delete-activity-btn block w-full text-left px-3 py-2 text-xs text-red-400 hover:bg-red-900/20"
                                            data-id="{{ activity.id }}"
                                            data-desc="{{ activity.activity_desc[:60]|e }}">
                                        <i class="fas fa-trash mr-2"></i>Delete
                                    </button>
                                </div>
                            </div>
                        </td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>
        </div>
    </div>
    {% endif %}
{% endfor %}

{% if not activities %}
<div class="glass rounded-lg shadow-xl p-12 text-center">
    <i class="fas fa-inbox text-secondary text-6xl mb-4 opacity-50"></i>
    <h3 class="text-xl font-semibold text-white mb-2">No ongoing activities</h3>
    <p class="text-secondary mb-6">Start by adding your first activity!</p>
    <a href="{{ url_for('activities.add_activity') }}" class="btn-black px-6 py-3 rounded-lg inline-flex items-center transition">
        <i class="fas fa-plus mr-2"></i>
        Add Activity
    </a>
</div>
{% endif %}

<!-- Floating action button (mobile) -->
<a href="{{ url_for('activities.add_activity') }}" class="fab no-print" title="Add Activity" aria-label="Add Activity">
    <i class="fas fa-plus"></i>
</a>

<!-- Recent Activity Rail (wide screens) -->
<div class="activity-rail no-print">
    <h4 class="text-lg font-semibold text-white mb-4 flex items-center">
        <i class="fas fa-stream mr-2"></i>
        Recent Activity
    </h4>
    <div class="space-y-3">
        {% if recent_updates %}
            {% for upd in recent_updates %}
            <div class="p-3 bg-dark-secondary rounded border border-dark text-xs">
                <div class="flex justify-between mb-1">
                    <span class="text-secondary font-medium">{{ upd.activity.activity_desc[:30] }}{% if upd.activity.activity_desc|length > 30 %}...{% endif %}</span>
                    <span class="text-secondary">{{ upd.created_at|timeago }}</span>
                </div>
                <div class="text-white">{{ upd.text[:60] }}{% if upd.text|length > 60 %}...{% endif %}</div>
                {% if upd.bp_snapshot %}
                <div class="mt-1 text-red-400 italic text-[10px]">Blockers: {{ upd.bp_snapshot[:40] }}{% if upd.bp_snapshot|length > 40 %}...{% endif %}</div>
                {% endif %}
            </div>
            {% endfor %}
        {% else %}
            <p class="text-secondary text-xs">No recent updates</p>
        {% endif %}
    </div>
</div>

<!-- Quick Update Modal -->
<div id="updateModal" class="hidden fixed inset-0 bg-black bg-opacity-70 flex items-center justify-center z-50">
    <div class="glass rounded-lg shadow-2xl p-8 max-w-2xl w-full mx-4">
        <div class="flex items-center justify-between mb-4">
            <h3 class="text-xl font-semibold text-white">
                <i class="fas fa-comment-medical text-white mr-2"></i>
                Add Quick Update
            </h3>
            <button onclick="closeUpdateModal()" class="text-secondary hover:text-white">
                <i class="fas fa-times text-2xl"></i>
            </button>
        </div>
        <p id="modalActivityDesc" class="text-secondary mb-4"></p>
        <form id="quickUpdateForm" method="POST">
            <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">
            <textarea id="modalUpdateText" name="update_text" rows="3" required
                      class="w-full px-4 py-3 bg-dark-secondary border border-dark rounded-lg text-white focus:outline-none transition mb-4"
                      placeholder="Progress update..."></textarea>
            <label for="modalBlockingPoints" class="block text-xs font-semibold text-secondary mb-1">Blocking Points (optional snapshot)</label>
            <textarea id="modalBlockingPoints" name="blocking_points" rows="2"
                      class="w-full px-3 py-2 bg-dark-secondary border border-dark rounded-lg text-white focus:outline-none transition mb-4"
                      placeholder="Current blockers or leave blank if unchanged"></textarea>
            <input type="hidden" name="redirect" value="dashboard">
            <div class="flex gap-4">
                <button type="submit" class="flex-1 btn-black font-semibold py-3 px-6 rounded-lg transition">
                    <i class="fas fa-save mr-2"></i>
                    Save Update
                </button>
                <button type="button" onclick="closeUpdateModal()" class="flex-1 bg-dark-secondary hover:bg-dark-hover border border-dark text-secondary font-semibold py-3 px-6 rounded-lg transition">
                    Cancel
                </button>
            </div>
        </form>
    </div>
</div>

<!-- Closing Note Modal -->
<div id="closingNoteModal" class="hidden fixed inset-0 bg-black bg-opacity-70 flex items-center justify-center z-50">
    <div class="glass rounded-lg shadow-2xl p-8 max-w-2xl w-full mx-4">
        <div class="flex items-center justify-between mb-4">
            <h3 class="text-xl font-semibold text-green-400">
                <i class="fas fa-flag-checkered text-green-400 mr-2"></i>
                Closing Activity
            </h3>
            <button onclick="closeClosingNoteModal()" class="text-secondary hover:text-white">
                <i class="fas fa-times text-2xl"></i>
            </button>
        </div>
        <p class="text-secondary mb-4">Please provide a reason for closing this activity:</p>
        <textarea id="closingNoteText" rows="4" required
                  class="w-full px-4 py-3 bg-dark-secondary border border-green-700/50 rounded-lg text-white focus:outline-none transition mb-4"
                  placeholder="Why was this activity closed? What was the outcome?"></textarea>
        <div class="flex gap-4">
            <button onclick="confirmClosingNote()" class="flex-1 bg-green-600 hover:bg-green-700 text-white font-semibold py-3 px-6 rounded-lg transition">
                <i class="fas fa-check-circle mr-2"></i>
                Close Activity
            </button>
            <button onclick="closeClosingNoteModal()" class="flex-1 bg-dark-secondary hover:bg-dark-hover border border-dark text-secondary font-semibold py-3 px-6 rounded-lg transition">
                Cancel
            </button>
        </div>
    </div>
</div>

{% endblock %}

{% block extra_js %}
<script src="{{ url_for('static', filename='js/dashboard.js') }}"></script>
{% endblock %}
