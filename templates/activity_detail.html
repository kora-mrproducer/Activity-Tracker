{% extends "layout.html" %}

{% block title %}{{ activity.activity_desc[:50] }}... - Activity Tracker{% endblock %}

{% block content %}
<div class="max-w-5xl mx-auto">
    <!-- Header with Back Button -->
    <div class="mb-6 flex items-center justify-between">
        <a href="{{ url_for('activities.dashboard') }}" class="text-secondary hover:text-white flex items-center gap-2 transition">
            <i class="fas fa-arrow-left"></i>
            <span>Back to Dashboard</span>
        </a>
        <a href="{{ url_for('activities.edit_activity', id=activity.id) }}" 
           class="btn-black px-6 py-2 rounded-lg transition flex items-center gap-2">
            <i class="fas fa-edit"></i>
            <span>Edit Activity</span>
        </a>
    </div>

    <!-- Activity Header Card -->
    <div class="glass rounded-lg shadow-xl p-6 mb-6">
        <div class="flex items-start justify-between mb-4">
            <div class="flex-1">
                <h1 class="text-2xl font-bold text-white mb-3">{{ activity.activity_desc }}</h1>
                <div class="flex flex-wrap gap-3 text-sm">
                    <!-- Status Badge -->
                    <span class="inline-flex items-center px-3 py-1 rounded-full text-xs font-medium
                        {% if activity.status == 'Ongoing' %}bg-blue-500/20 text-blue-400 border border-blue-500/30
                        {% elif activity.status == 'Closed' %}bg-green-500/20 text-green-400 border border-green-500/30
                        {% else %}bg-gray-500/20 text-gray-400 border border-gray-500/30{% endif %}">
                        <i class="fas fa-circle text-xs mr-1.5"></i>
                        {{ activity.status }}
                    </span>
                    
                    <!-- Priority Badge -->
                    <span class="inline-flex items-center px-3 py-1 rounded-full text-xs font-medium
                        {% if activity.priority == 'High' %}bg-red-500/20 text-red-400 border border-red-500/30
                        {% elif activity.priority == 'Medium' %}bg-yellow-500/20 text-yellow-400 border border-yellow-500/30
                        {% else %}bg-blue-500/20 text-blue-400 border border-blue-500/30{% endif %}">
                        <i class="fas fa-flag mr-1.5"></i>
                        {{ activity.priority }}
                    </span>
                </div>
            </div>
        </div>

        <!-- Activity Metadata -->
        <div class="grid grid-cols-1 md:grid-cols-3 gap-4 mb-4">
            <div class="bg-dark-secondary/50 rounded-lg p-4">
                <div class="text-xs text-secondary mb-1">Source</div>
                <div class="text-white font-medium">{{ activity.source or 'Not specified' }}</div>
            </div>
            <div class="bg-dark-secondary/50 rounded-lg p-4">
                <div class="text-xs text-secondary mb-1">Start Date</div>
                <div class="text-white font-medium">{{ activity.start_date.strftime('%B %d, %Y') }}</div>
            </div>
            <div class="bg-dark-secondary/50 rounded-lg p-4">
                <div class="text-xs text-secondary mb-1">
                    {% if activity.status == 'Closed' %}End Date{% else %}Expected End{% endif %}
                </div>
                <div class="text-white font-medium">
                    {% if activity.end_date %}
                        {{ activity.end_date.strftime('%B %d, %Y') }}
                    {% else %}
                        <span class="text-secondary">Not set</span>
                    {% endif %}
                </div>
            </div>
        </div>

        <!-- Stats Row -->
        <div class="grid grid-cols-3 gap-4 pt-4 border-t border-dark">
            <div class="text-center">
                <div class="text-2xl font-bold text-white">{{ stats.days_active }}</div>
                <div class="text-xs text-secondary">Days Active</div>
            </div>
            <div class="text-center">
                <div class="text-2xl font-bold text-white">{{ stats.update_count }}</div>
                <div class="text-xs text-secondary">Total Updates</div>
            </div>
            <div class="text-center">
                <div class="text-2xl font-bold {% if stats.days_since_update > 7 %}text-yellow-400{% else %}text-white{% endif %}">
                    {{ stats.days_since_update }}
                </div>
                <div class="text-xs text-secondary">Days Since Update</div>
            </div>
        </div>

        <!-- Blocking Points (if any) -->
        {% if activity.blocking_points and activity.blocking_points.strip() %}
        <div class="mt-4 pt-4 border-t border-dark">
            <div class="flex items-start gap-3 bg-red-500/10 border border-red-500/30 rounded-lg p-4">
                <i class="fas fa-exclamation-triangle text-red-400 text-lg mt-0.5"></i>
                <div class="flex-1">
                    <div class="text-sm font-semibold text-red-400 mb-1">Blocking Points</div>
                    <div class="text-sm text-white whitespace-pre-wrap">{{ activity.blocking_points }}</div>
                </div>
            </div>
        </div>
        {% endif %}

        <!-- Tags (if any) -->
        {% if activity.tags and activity.tags.strip() %}
        <div class="mt-4 pt-4 border-t border-dark">
            <div class="flex items-center gap-2 flex-wrap">
                <i class="fas fa-tags text-secondary text-sm"></i>
                {% for tag in activity.tags.split(',') %}
                    <span class="px-2 py-1 bg-dark-secondary border border-dark rounded text-xs text-secondary">
                        {{ tag.strip() }}
                    </span>
                {% endfor %}
            </div>
        </div>
        {% endif %}
    </div>

    <!-- Quick Update Form -->
    <div class="glass rounded-lg shadow-xl p-6 mb-6">
        <h2 class="text-lg font-semibold text-white mb-4 flex items-center gap-2">
            <i class="fas fa-comment-medical text-primary"></i>
            Add Quick Update
        </h2>
        <form action="{{ url_for('activities.add_update', id=activity.id) }}" method="POST">
            <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">
            <input type="hidden" name="redirect" value="detail">
            
            <textarea name="update_text" rows="3" required
                      class="w-full px-4 py-3 bg-dark-secondary border border-dark rounded-lg text-white focus:outline-none focus:border-primary transition mb-3"
                      placeholder="What's the progress on this activity?"></textarea>
            
            <div class="mb-4">
                <label for="blocking_points_update" class="block text-xs font-semibold text-secondary mb-2">
                    Update Blocking Points (optional)
                </label>
                <textarea name="blocking_points" id="blocking_points_update" rows="2"
                          class="w-full px-3 py-2 bg-dark-secondary border border-dark rounded-lg text-white focus:outline-none transition text-sm"
                          placeholder="Leave blank to keep current blockers unchanged">{{ activity.blocking_points or '' }}</textarea>
            </div>
            
            <button type="submit" class="btn-black px-6 py-2 rounded-lg transition flex items-center gap-2">
                <i class="fas fa-save"></i>
                <span>Save Update</span>
            </button>
        </form>
    </div>

    <!-- Update Timeline -->
    <div class="glass rounded-lg shadow-xl p-6">
        <h2 class="text-lg font-semibold text-white mb-4 flex items-center gap-2">
            <i class="fas fa-history text-primary"></i>
            Update Timeline
            <span class="text-sm text-secondary font-normal">({{ stats.update_count }} total)</span>
        </h2>

        {% if updates %}
            <div class="space-y-4">
                {% for update in updates %}
                <div class="relative pl-8 pb-4 {% if not loop.last %}border-l-2 border-dark-secondary{% endif %}">
                    <!-- Timeline Dot -->
                    <div class="absolute left-0 top-1 w-3 h-3 bg-primary rounded-full -ml-[7px] ring-4 ring-dark"></div>
                    
                    <!-- Update Card -->
                    <div class="bg-dark-secondary/50 rounded-lg p-4 hover:bg-dark-secondary transition">
                        <div class="flex items-center justify-between mb-2">
                            <div class="text-xs text-secondary">
                                <i class="fas fa-clock mr-1"></i>
                                {{ update.created_at|timeago }}
                                <span class="mx-2">â€¢</span>
                                {{ update.created_at.strftime('%B %d, %Y at %I:%M %p') }}
                            </div>
                        </div>
                        <div class="text-white whitespace-pre-wrap">{{ update.text }}</div>
                        
                        <!-- Blocker Snapshot (if different from empty) -->
                        {% if update.bp_snapshot and update.bp_snapshot.strip() %}
                        <div class="mt-3 pt-3 border-t border-dark">
                            <div class="text-xs text-yellow-400 mb-1 flex items-center gap-1">
                                <i class="fas fa-exclamation-circle"></i>
                                Blockers at this time:
                            </div>
                            <div class="text-xs text-secondary italic">{{ update.bp_snapshot }}</div>
                        </div>
                        {% endif %}
                    </div>
                </div>
                {% endfor %}
            </div>
        {% else %}
            <div class="text-center py-12 text-secondary">
                <i class="fas fa-comment-slash text-4xl mb-3 opacity-50"></i>
                <p>No updates yet. Be the first to add one!</p>
            </div>
        {% endif %}
    </div>
</div>
{% endblock %}
